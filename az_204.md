AZ-204:

# Module 1: Explore Azure App Service:

1. Implement Azure App Service web apps

    - HTTP-based service for hosting web apps, REST APIS, etc. in Windows- or Linux-based environments.
    - Auto-scale of resources and container support
    - CI/CD support
    - DEV and PROD slot dep. On payment plan
    - App Service support different runtimes, check with: `az webapp list-runtimes --os-type linux`
    - A custom container option is supported, helps to avoid limits; like storage volume latency,
      it places files in the container filesystem instead of on the content volume
    -
2. Examine Azure App Service plans

    - An App Service plan defines a set of compute resources for a web app to run
    - Each App Service plan defines:

        - Operating System (Windows, Linux)
        - Region (West US, East US, etc.)
        - Number of VM instances
        - Size of VM instances (Small, Medium, Large)
        - Pricing tier: Shared, Dedicated, Isolated (runs with others, runs all yours, runs only this one app)
    - App Service Plan is a scale unit: all apps run on all VMs defined, more resources needed → isolate in a separate
      service plan

3. Deploy to App Service

    - App Service supports both automated and manual deployment
    - CI/CD from:

        - Azure DevOps Services
        - GitHub
        - BitBucket
    - Manual deployment:

        - Git URL
        - CLI: `webapp up` (can create a new app)
        - `curl`: send ZIP resources to App Service
        - FTP/S
    - Deployment slots: allows deploying to staging and swap staging and prod → swap warms up the worker
    - Container deployment:

        - Build and tag the image
        - Push the tagged image
        - Update the deployment slot with the new image tag

4. Explore authentication and authorization in App Service

    - Built-in authentication feature: supports Auth without own implementing
    - Multiple providers supported (Facebook, Googel, GitHub, any OpenID provider like Okta)
    - Any HTTP request passes through auth module:

        - Authenticates users and clients with the specified identity provider
        - Validates, stores, and refreshes OAuth tokens issued by the configured identity provider
        - Manages the authenticated session
        - Injects identity information into HTTP request headers
    - Can be configured using Azure Resource Manager settings or using a configuration file
    - Authentication flow:

        - Without provider SDK: browser apps, rendering a sign-in form from provider
        - With provider SDK: browser less apps without sig-in form from provider; manually sign-in and then submit the
          auth token to App Service for validation
    - Authorization behavior:

        - Allow unauthenticated requests
        - Require authentication
    - App Service provides a built-in token store

5. Discover App Service networking features

    - Problem: you can't connect the App Service network directly to your network (thre is not only you as a customer)
    - There are in- and outbound features to control calls to and from your app
    - Roles: fron ends (for incoming calls) and workers (for user tasks)
    - Default behavior: all apps on one worker, if scaled, all apps are replicated to a new one
    - Outbound addresses: there's a property called `possibleOutboundIpAddresses` (all possible)
      or `outboundIpAddresses` that lists them:

      ```
      az webapp show \
      --resource-group <group_name> \
      --name <app_name> \
      --query outboundIpAddresses \
      --output tsv
      ```
6. Example: creating a static HTML app and deploy to Azure App Service:

    - Using the Azure CLI command: `az webapp up`:

        - Create a default resource group if one isn't specified.
        - Create a default app service plan.
        - Create an app with the specified name.
        - Zip deploy files from the current working directory to the web app.
    - Set variables to hold the resource group and app names:
      `resourceGroup=$(az group list --query "[].{id:name}" -o tsv) appName=az204app$RANDOM`
    - Create web app: `az webapp up -g $resourceGroup -n $appName --html`

7. Deployment and scaling options:

    - Deployment slots: we need at least a standard plan
    - Slots are live apps, where we can deploy different versions of our app
    - We can have one slot each stage (DEV, STAGING, PROD)
    - Use Swaps to turn the code from f. e.
      STAGING into PROD without a new deployment.
      The advantage of this: we can
      always swap back to the previous PROD version if needed
    - We can always keep all configs using deployment slot levels (db connections, etc.)

8. Settings of web apps:

    - Under Configuration/General settings, we can adjust programming language, version, cookies, certification, etc.
    - error pages: custom HTMLs being shown by status codes
    - TLS/SSL settings and certificates: app service manages certificates for custom domains (payment required)

9. Autoscaling of web apps:

    - Two options available: scaling up or scaling out. The First one is to use a bigger machine, the second one is to
      use more machines
    - Scaling up is bounded, regardless of payment plan, so scaling out is the best way to go
    - Example: scaling out from 1 to 2: we have 2 VMs and Azure takes care of load balancing (incoming traffic is
      randomly assigned to 1 or 2)
    - Auto-scaling: based on schedule and metrics (# users, CPU %, etc.)
    - Based on metrics, we define rules on which auto-scaling is triggered
    - There is always a rule for scaling up AND scaling down required to save costs
    - We can also scale on time (9-5 Mon-Fr or so)
    - Scaling on alerts: we can programmatically set auto-scaling based on logs

10. Diagnostic logs

    - Metrics can be found in Webbapp Overview/Monitoring
    - Further down on the left Monitoring/... we find different logs
    - Alerts and Metrics are NOT covered by the exam
    - Application logs:
        - we can turn on app logging on a given level and store log files ether in filesystem or in blob
          storage
        - We can download logs using FTP(S)
        - Common exam question here: "How do you track failed requests to your web app?"
        - Answer: "By turning on Failed request tracing"
    - Diagnostic settings:
        - A way of collecting logs into analytic workspace
        - If this menu is not loading, you need to register `Microsoft.HDInsight` resource
          provider:
        - To register a subscription with Microsoft.HDInsight in Azure, follow these steps:

            1. Sign in to the Azure portal and select "Subscriptions."
            2. Choose the subscription where you want to enable the Microsoft.Insights provider.
            3. Under the "Settings" section, select "Resource providers."
            4. In the filter box, enter "insight" to find the Microsoft.Insights provider.
            5. If the status of the provider is "NotRegistered," select the Microsoft.HDInsight
               provider and then click "Register."
        - We can create a new diagnostic based on types in the list and choose destination details
    - Logs:
        - We can then run log queries under Monitoring/Logs section. There is KQL language used for that
    - Log Stream:
        - logs in real time as stream here (app logs or web server logs)

11. DEMO: Create a Web App in local PowerShell

    - open CLI and type `pwsh` to start PowerShell
    - Type get-command to list all available commands
    - Usage of wild cards: `get-command *AzWebapp`
    - Creating a new Web App:
        - Find out the current subscription id: `Get-AzSubscription`
        - Then set the subscription by using `Select-AzSubscription {subscription id}`
        - Create a new resource group: `New-AzResourceGroup -Location 'EastUS' -Name 'powershellwebapp'`
        - Create a new App Service Plan:
          `New-AzAppServicePlan -Name 'aznewweabappserviceplan1' -Location 'EastUS' -ResourceGroupName 'powershellwebapp' -Tier Free -NumberofWorkers 2 -WorkerSize "Small"`
        - If you get an unauthorized error, check your account permissions:
          `Get-AzRoleAssignment -ResourceGroupName 'powershellwebapp'` or switch to another region
        - Now create a new Web App within the Service Plan:
          `New-AzWebApp -ResourceGroupName 'powershellwebapp' -Name 'newpowershellwebapp1' -Location 'WestEurope' -AppServicePlan 'aznewweabappserviceplan1'`

12. DEMO: Create a Web App in CLI

    - Create a new resource group: `az group create --name cliwebapp --location eastus`
    - Create a new App Service Plan: `az appservice plan create -g cliwebapp -n cliwebappsp234 --location westeurope`
    - Now create a new Web App within the Service Plan: `az webapp create -g cliwebapp -n newcliwebapp1 -p cliwebappsp234`